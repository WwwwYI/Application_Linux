研究生阶段到目前为止，参与过三个项目，我简单的介绍一下这三个项目：首先是智能大蒜联合收获机；

### 1.大蒜联合收获机

这个项目是与江苏省农业自动化研究  院的一起合作的大蒜联合收获机的项目，传统的收获机，操作人员在田间行驶时是不知道整个车辆的一个行驶状态，所以我门的主要目的就是在车辆的关键部门安装传感器，将车辆的行驶数据显示到上位机的屏幕中，其中涉及到的传感器有，传感器包括了霍尔——>传动输送链、扭矩——>挖掘阻力、液压——>夹持失踪链速度、重量传感器——>粮仓的重量。MCU采用STM32微控制器，开发环境采用keil5，==整个项目主要是采用片上外设ADC==将模拟信号量转换成数字量，与定时器的输入捕获采集，结合自己制定的串口通信协议最后显示在上位机软件界面中。

**串口：**

串口通信协议编写：

发送数据帧：

一个数据帧是FF开头，第二位表示整个数据包的长度，而第三位表示控制命令

接收数据帧：

协议规定啊35位，数据帧以FF开头，第二位固定式23（表示35个数据）前十个data位保留，防止以后加入更多的测量数据，后面adc转换的数据取平均之后，存入到发送的buf中，通过定时更新中断处理函数把数据发到串口==定时器的值没有计算嘛==	                                                                                                                                                                                                                                                                               

**ADC**:

采用多通道轮询的工作方式，模拟量转换成数字量之后，存储在ADC的数据寄存器，开启DMA的数据传输方式，内存中存储一个10 * 4的二维数组，每一行存储的是每一次 四个ADC转换的值，一共采集十次后取平均值。

我主要负责的是==串口的通讯协议==和==ADC外设==的编写。

**定时器**：

进行定时操作，实现串口以固定的时间间隔向上位机发送数据。用到了基本定时器的更新中断，设定==ARR==的值和时钟分频因子PSC的值，得到产生更新终端的间隔时间，在中断处理函数中，就是根据串口的通信协议，将测到的数据依次填入发送缓存数组中。在中断函数中更新一个发送数据标志位为1

**main**

在主函数中依次轮询串口的接收数据标志位和 发送数据标志位，进行下相应的处理函数，并将标志位置0

遇到的问题：

因为之前老师也有与农科院合作过其他的联合收获机的项目，软件层用的都是之前的一套代码框架，代码层面基本上没有出现什么问题，在去现场之前都在实验室调试好之后再去现场实际测试的。遇到的问题就是第一次实际的现场接线，有很多不规范的操作

比如连接电源时候不知道共地的操作，整个板子是12V的电源供电，部分传感器是24V的电源供电，从车上的蓄电池电源引出两个电源的时候 ，地没有共在一起，导致两个地之间有12v的压差，重量传感器的接线端子只要一插上板子线就烧断了（==原因==）不管板子有没有供电，当时一直找原因找不到。

其次我们一直是带电工作的，是一件很危险的事。后来学长看到之后和我们说 要在电源引出来的时候就接上一个开关，这样子调试的时候再按下开关通电，不然因为都是自己剥线，布线，那么复杂的一个设备难免会有裸露的地方，电源和地一短接到一起就整个导线就烧了。

### 2.车载检测系统

第二个项目是与南京空军四站厂合作的，他们主要是为南京军区的战机提供一个地面保障车辆，所以车辆平时的运行状态 也是需要检测的，但是不同于第一个项目，将数据实时的显示到上位机屏幕中。部队中是有严格的保密制度，检测到的数据只能以文件的形式被保存到硬盘中等到相关的工作人员进行读取，项目主要分为模拟量采集端口与数字量采集端口，这次的模拟量采集不是使用片上外设ADC，而是采用ADS1110的转换芯片，将读到的模拟量数据转换成数字量后存储在芯片内部，之后通过IIC的通讯协议将数据发送给STM32，数字量就是读取车上的某个开关时开还是闭。将读取的数据通过串口通信的方式，发给另一块NXP公司的芯片IMX6ULL，芯片烧录了Linux的发行版——debian的操作系统，简单的写了一个python的运行脚本，将串口发送来的数据打包读取到一个文件中进行保存，等待相关工作人员读取数据。

在初期的实验设计方案中还有加入485通信和CAN通信，这两个通信协议也都有去了解并且代码实现了通讯过程，但是之后因为我去帮另一个老师完成第三个项目和疫情的原因没办法去实地进行测量。之后就没有参与到这个项目中。但是也是因为这个项目，是我对linux操作系统的启蒙，虽然项目中没有涉及到linux操作系统的一些知识，但是之后我主动的开始探寻了linux操作系统的一些奥秘，学习了linux操作系统的多线程，多进程的编程，以及进程、线程间的通信机制。目前也掌握了一些网络通信的知识，但是没有实际的项目将学到的知识落地，也是因为这个，我想从事嵌入式开发的原因。毕竟裸机的编程已经是十几年前的技术了，现在还是要上操作系统的。



==IIC驱动代码==：

读ADS1110时，在实验室测试的时候，因为实验室没办法测负的电压，当接口什么都不接的时候电压是0，但是由于元器件的温漂，12路的IIC信号，有的是比零大一点点儿，有的却是FFFE，是一个特别大的数，后来就查阅datasheet发现ADS1110里面存放的是一个有符号数，而串口发送的是一个无符号数。后来就对数据进行处理才发送到串口。

==CAN通讯==：

这个一开始项目中是准备使用的，整个电路板上也设计了CAN的外设，因为一开始了解到车上的通讯基本上是使用CAN的，但是在实验室测板子的时候，代码正确的情况下，我们设定了500ms发送一次报文数据，但是示波器显示一直在不间断的发送数据，后来通过示波器了解到，在can的控制器将差分的CAN信号转变成CAN TX和CAN RX后，电路中设计了一个光耦隔离的部分，但是用两路信号观测光耦隔离的输入和输出端，中间有一微秒的延迟，而CAN的通信速率也是1Mbps，导致寻址都寻不到，所以一直在发报文寻址。

GPIO有的引脚默认功能不是做IO口的时候需要重映射



==stm32与imx6ull通信的代码==



### 3.无人化学实验室

第三个是与我们学校化学学院合作的一个项目，还正在进行过程中，目前完成了第一代的产品，正在进行迭代升级。最终的目的时要建立一个无人的化学实验室，实验人员只需要在上位机软件界面将实验原料配置好，并将原料摆在试验台相应的位置，就可以离开，最终会得到一个产品的检验报告。

我负责的部分是完成一个移液工作站，这个工作站代替人完成实验的一系列操作。整个移液工作站的非标自动化的设计工作是我和老师一起用shapr3D这个软件完成的。目前工作站支持三个实验操作，分别是将反应物从试剂瓶取出移入试管混合，以及用针管取出反应完的液体进行过滤操作后滴入要检测的进样瓶中等待送入专业的检测设备进行成分检测。其次是给进样瓶进行一个封盖处理，防止里面的有机产物挥发。这些功能的实现都是通过控制步进电机间的相互配合完成的。步进电机是采用modbus的报文类型，利用485通信对每个电机的驱动器进行控制。整个工程的代码是通过python实现的。

不过实现整个无人的实验室环境，还需要机械臂进行原料和试管的搬运工作，所以我们整个的流程控制是由一个控制软件进行调控的，而上位机与我们之间的是采用ZMQ进行通讯。我们接收消息是采用订阅模式，上位机是发布端，我们每个agent是订阅端，上位机发布消息时订阅段都可以接收到。但是这是一个单工的通讯，发布端只可以发布消息，订阅段只可以接受消息。所以当我们将运行状态返回给上位机时 采用的是ZMQ的另一种工作模式叫做应答模式，这种模式必须时先提问在应答。下位机此时是提问方，而上位机此时是应答方。中间的消息是以json字符串的形式发送，各自解析得到运行时需要的参数。

因为是第一代移液器，所以在实验过程中还有很多缺陷。目前正在进行一个彻底的更新换代，也正在与老师和同学一起讨论研究方案，目前是打算加入视觉的部分进行定位，但是这一块我还不是很了解，所以还有很多要学习和进步的空间。

这就是我目前参与的三个项目的一个大致介绍。





ZMQ通信：

PUB_SUB模式：

pub是发布端，sub是订阅端 一个发布者可以有多个订阅者 1：n

发布端数据变化时，所有订阅者均能够收到消息并处理。 sub端可以利用setsocketopt对于消息进行过滤。

PUB-SUB模式是半双工的，订阅端只可以recv，send的话会出现错误，而发布端只可以send，recv也会发证错误。



这个项目的上层是一个进行流程控制的上位机，上位机与下层的机械臂与移液器这两个agent通过ZMQ进行信息交互，交互的内容是使用json字符串的格式，agent单元在自己的程序代码中解析json字符串并进行相应的操作。

ZMQ通信模式采用的是PUB_SUB的模式，上位机是发布端，下层的操作设备是订阅端，一个发布端可以有多个订阅段，但是PUB-SUB模式是半双工的，订阅端只可以接受，而发布端只可以发送。

但是整个项目中还需要下位机返回运行的状态给上位机，所以还要再建立一ZMQ的socket，采用REP-REQ(应答模式)，这个模式的特点在于一问一答，必须先提问，对于一个提问只能回答一次，没有收到回答的时候是不可以提问的。

利用485控制电机 封装最基本的几个函数，包括电机的初始化参数，读取电机状态，电机定位，电机正反转等，在根据具体要完成的工作控制各个电机的协调工作。这部分就是根据具体实验的步骤设计动作，用于自己单机测试